<?php
/**
 * An Zend_Auth adapter that authenticates against a password file generated by Apache's htpasswd utility.
 *
 * @author jahufar
 */
class Nexva_Util_Auth_Adapter_Htpasswd implements Zend_Auth_Adapter_Interface {

    protected $_passwdFile = null;
    protected $_username = null;
    protected $_password = null;

    /**
     * Constructor
     *
     * @param string $username Username
     * @param string $password Password (plain-text)
     * @param string $passwdFile The htpasswd file to authenticate again. If not supplied, will auto-detect from config (nexva.application.authfile)
     */
    public function  __construct($username, $password, $passwdFile = null) {
    
        $this->_username = $username;
        $this->_password = $password;
        $this->_passwdFile = $passwdFile;
    }

    /**
     * Authenticates a user in the htpasswd file
     *
     * @return Zend_Auth_Result
     */
    public function authenticate() {

        $passwdFile = $this->_passwdFile;

        if( is_null($this->_passwdFile)) $passwdFile = Zend_Registry::get('config')->nexva->application->authfile;

        $auth = new Nexva_Util_Auth_Htpasswd();

        $success = $auth->authenticate($this->_username, $this->_password, $passwdFile);

        if( $success ) {

            $returnObject = new stdClass();
            $returnObject->id = 0;
            $returnObject->username = $this->_username;


            return new Zend_Auth_Result(Zend_Auth_Result::SUCCESS, $returnObject);
        }

        return new Zend_Auth_Result(Zend_Auth_Result::FAILURE_CREDENTIAL_INVALID, $this->_username);

    }

}
