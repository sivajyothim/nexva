<?php
/**
 * A library that can parse and authenticate users from a file generated by Apache's htpasswd utility.
 *
 * Note: The only encryption scheme supported is DES
 *
 * @author jahufar
 */
class Nexva_Util_Auth_Htpasswd {

    /**
     * Authenticates a a user $username by password $password
     *     
     * @param string $userName
     * @param string $password
     * @param string $passwordFile The password file generated by htpasswd.
     * @return boolean TRUE if successful, FALSE if not
    */

    public function authenticate($userName, $password, $passwordFile) {

        if(!file_exists($passwordFile) || !is_readable($passwordFile))
            throw new Exception('Password file not found: '.$passwordFile);

        $fp=fopen($passwordFile,'r');
            if(!$fp) throw  new Exception("Unable to open password file $passwordFile for reading");
                   
        while($line = fgets($fp)) {
            
            $line = preg_replace('`[\r\n]$`','',$line); //for each line in the file remove line ending

            list($user,$pass) = explode(':',$line);

            if($user == $userName){
                fclose($fp);
                $salt = substr($pass,0,2); //the salt is the frst 2 characters for DES encryption
                $test_pw = crypt($password,$salt); //use the salt to encode the submitted password

                if($test_pw == $pass) return true; else return false;
            }

        }
                  
    }


}
?>
